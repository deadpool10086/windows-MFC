<html> <head> <meta http-equiv="Content-Type" content="text/html; charset=gb2312" /> <title></title> <link href="inc/style.css" rel="stylesheet" type="text/css"> </head>  <body class=infobody> <table width="100%" height="100%" cellspacing="0">  <tr>  <td valign="top"> <table>   <tr>   <td height=25></td>   </tr>           <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" style="border-bottom:#1873b5 solid 1px">             <tr><td style="background-image:url(images/cinfo_left.GIF);display:" width="5"></td>               <td width="86" height="28" style="padding-left:4px;padding-right:4px;background-image:url(images/cinfo_center.GIF);color:#3081bd;text-align:center;padding-bottom:0px;padding-top:4px;display:"><nobr>内容摘要</nobr></td> <td style="background-image:url(images/cinfo_right.GIF);display:" width="5"></td>               <td>&nbsp;</td>             </tr>           </table>           <table width="100%" border="0" align="center" cellpadding="5" cellspacing="1" bgcolor="#FFFFFF" style="border:#1873b5 solid 1px;border-top:0px">             <tr>               <td bgcolor="#F5FAFA" style="padding-left:20;padding-right:20px" id="ptitle">七.&nbsp;FTP连接、通信与传送<BR>&nbsp;&nbsp;&nbsp; 1.&nbsp; 连接<BR>&nbsp;&nbsp;&nbsp; 2.&nbsp; 通信<BR>&nbsp;&nbsp;&nbsp; 3.&nbsp; 文件传送</td>             </tr>           </table> <table>   <tr>   <td height=25></td>   </tr>           <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" style="border-bottom:#1873b5 solid 1px">             <tr><td style="background-image:url(images/cinfo_left.GIF);display:" width="5"></td>               <td width="86" height="28" style="padding-left:4px;padding-right:4px;background-image:url(images/cinfo_center.GIF);color:#3081bd;text-align:center;padding-bottom:0px;padding-top:4px;display:"><nobr>相关内容</nobr></td> <td style="background-image:url(images/cinfo_right.GIF);display:" width="5"></td>               <td>&nbsp;</td>             </tr>           </table>           <table width="100%" border="0" align="center" cellpadding="5" cellspacing="1" bgcolor="#FFFFFF" style="border:#1873b5 solid 1px;border-top:0px">             <tr>               <td bgcolor="#F5FAFA" style="padding-left:20;padding-right:20px" id="ptitle"><P><STRONG>七.&nbsp;FTP连接、通信与传送</STRONG><BR><STRONG>1.&nbsp;连接<BR></STRONG>&nbsp;&nbsp;&nbsp; 两个FTP连接（控制和数据）使用不同的策略和不同的端口号。<BR>&nbsp;&nbsp;&nbsp; （1）&nbsp;控制连接<BR>&nbsp;&nbsp;&nbsp; 创建控制连接的方法共有两个步骤：<BR>&nbsp;&nbsp;&nbsp; ①&nbsp;服务器在熟知端口21发出被动打开，等待客户。<BR>&nbsp;&nbsp;&nbsp; ②&nbsp;客户使用短暂端口发出主动打开。<BR>&nbsp;&nbsp;&nbsp; 在整个过程中这个连接一直是打开的。IP协议使用的服务类型是最小延迟，因为这是用户（人）和服务器的交互式连接。用户键入命令并期望收到的响应延时不太大。图10-2给出了服务器和客户之间的初始连接：</P>
<P align=center><IMG src="../upload/1223274802390_pic.gif"></P>
<P align=center>图10-2&nbsp; 打开控制连接</P>
<P>&nbsp;&nbsp;&nbsp; （2）&nbsp;FTP数据连接的两种模式<BR>&nbsp;&nbsp;&nbsp; FTP的数据连接存在两种模式：主动模式和被动模式。主动（PORT）模式是从服务器端向客户端发起连接；被动（PASV）模式是客户端向服务器端发起连接。<BR>&nbsp;&nbsp;&nbsp; 当FTP被设置为主动模式时，它的连接过程如下：首先客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条控制连接。当需要传输数据时，客户端在控制连接上用PORT命令告诉服务器：“我打开了XXXX端口，你来连接我”。于是服务器从20端口向客户端的XXXX端口发送连接请求，最后建立一条数据连接来传输数据。</P>
<P align=center><IMG src="../upload/1223274809656_pic.gif"></P>
<P align=center>图10-3&nbsp; FTP的主动模式</P>
<P>&nbsp;&nbsp;&nbsp; 当FTP被设置为被动模式时，它的连接过程如下：首先客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条控制连接。当需要传输数据时，服务器在命令链路上用PASV命令告诉客户端：“我打开了XXXX端口，你来连接我”。于是客户端向服务器的XXXX端口发送连接请求，最后建立一条数据连接来传输数据。</P>
<P align=center><IMG src="../upload/1223274817140_pic.gif"></P>
<P align=center>图10-4&nbsp; FTP的被动模式</P>
<P>&nbsp;&nbsp;&nbsp; 当进行FTP连接时，Internet Explorer通常被设置为被动模式，而FTP客户端软件（如：FlashFXP、CutFTP）一般为主动模式。如果服务器和客户端之间存在防火墙，主动模式经常会引起一些麻烦。例如：客户端位于防火墙之后，通常防火墙允许所有内部向外部的连接通过，但是对于外部向内部发起的连接却存在很多限制。在这种情况下，客户可以正常地和服务器建立控制连接，而如果使用主动模式的数据连接，一些数据传输命令就很难成功运行，因为防火墙会阻塞从服务器向客户发起的数据传输连接。因此在使用主动模式的FTP数据连接时，防火墙上的配置会比较麻烦。<BR><STRONG>2.&nbsp;通信<BR></STRONG>&nbsp;&nbsp;&nbsp; 在不同计算机上运行的FTP客户和FTP服务器必须能够彼此进行通信。这两台计算机可以使用不同的操作系统、不同的字符集、不同的文件结构以及不同的文件格式。FTP必须使这种异构性得到兼容。<BR>&nbsp;&nbsp;&nbsp; FTP使用了两种解决问题的方法，一种是控制连接，另一种是数据连接。<BR>&nbsp;&nbsp;&nbsp; （1）&nbsp;在控制连接上的通信<BR>&nbsp;&nbsp;&nbsp; FTP使用如TELNET或SMTP之类的方法在控制连接上通信。它使用NVT ASCⅡ字符集，如图10-5所示。通信是通过命令和响应来完成的。这种简单的方法对控制连接是合适的，因为我们一次发送一条命令（响应）。每一条命令或响应都是一个短行，因此我们不必担心它的文件格式或文件结构。每一行的结束处是两字符（回车和换行）的行结束记号。</P>
<P align=center><IMG src="../upload/1223274825546_pic.gif"></P>
<P align=center>图10-5&nbsp; 使用控制连接</P>
<P>&nbsp;&nbsp;&nbsp; （2）&nbsp;在数据连接上的通信<BR>&nbsp;&nbsp;&nbsp; 数据连接的目的和实现与控制连接的不同。我们通过数据连接来传送数据。客户必须定义要传送的文件类型、数据结构以及传输方式。在数据连接上传送数据之前，我们通过控制连接准备传输。异构性问题可以由定义3个通信属性来解决：文件类型、数据结构以及传输方式，如图10-6所示：</P>
<P align=center><IMG src="../upload/1223274832125_pic.gif"></P>
<P align=center>图10-6&nbsp; 使用数据连接</P>
<P>&nbsp;&nbsp;&nbsp; ①&nbsp;文件类型：<BR>&nbsp;&nbsp;&nbsp; FTP能够在数据连接上传送下列文件类型中的一种：<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; ASCⅡ文件：这是传送文本文件的默认格式。每一个字符使用NVT ASCⅡ进行编码。发送端把文件从它自己的表示转换成NVT ASCⅡ字符，而接收端从NVT ASCⅡ字符转换成它自己的表示。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; EBCDIC文件：若连接的一端或两端使用EBCDIC编码，则可使用EBCDIC编码传送文件。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 图像文件：这是传送二进制文件的默认格式。这种文件是作为连续的位流传送而没有任何解释或编码。这在大多数情况下是用来传送二进制文件，如已编译的程序。<BR>&nbsp;&nbsp;&nbsp; ②&nbsp;数据结构：<BR>FTP可以使用下面对数据结构的解释中的一种，在数据连接上传送文件：<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 文件结构（默认）：这种文件没有结构。它是连续的字节流。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 记录结构：这种文件划分为一些记录，这只能用于文本文件。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 页面结构：这种文件划分为一些页面，每一个页面有页面号和页面首部。页面可以随机地或顺序地进行存取。<BR>&nbsp;&nbsp;&nbsp; ③&nbsp;传输方式：<BR>&nbsp;&nbsp;&nbsp; FTP可以使用下面3种传输方式之一在数据连接上传送文件：<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 流方式：这是默认方式。数据作为连续的字节流从FTP交付给TCP。TCP负责把数据划分为适当大小的报文段。若数据是简单的字节流（文件结构），就不需要文件结束符。在这种情况下的文件结束就是由发送端来关闭数据连接。若数据划分为记录（记录结构），则每一个记录有1字节的记录结构（EOR）字符，而在文件的结束处有文件结束（EOF）字符。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 块方式：数据可以按块从FTP交付给TCP。在这种情况下，每一个块的前面有3字节首部。第一个字节叫做块描述符，后两个字节定义块的大小，以字节为单位。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 压缩方式：若文件很大，数据可进行压缩。通常使用的压缩方法是游程长度编码。在这种方法中，数据单元的连续出现数可以用一个“出现”和“重复数”来替换。在文本文件中，这通常是空格。在二进制文件中，空字符常常被压缩。<BR><STRONG>3.&nbsp;文件传送</STRONG><BR>&nbsp;&nbsp;&nbsp; 在控制连接命令的控制下，在数据连接上进行着文件传送。但是，我们应当记住，在FTP的文件传送表示3件事中的一个，如图10-7所示：</P>
<P align=center><IMG src="../upload/1223274839656_pic.gif"></P>
<P align=center>图10-7&nbsp; 文件传送</P>
<P>&nbsp;&nbsp;&nbsp; 从服务器把文件复制到客户。这叫做读取文件。这是在RETR命令的监督下完成的。<BR>&nbsp;&nbsp;&nbsp; 从客户把文件复制到服务器。这叫做存储文件。这是在STOR命令的监督下完成的。<BR>&nbsp;&nbsp;&nbsp; 从服务器向客户发送目录列表或文件名。这是在LIST命令的监督下完成的。应注意的是，FTP把目录或文件名列表当作文件。它在数据连接上发送。</P></td>             </tr>           </table>  </td> </tr> </table> </body> </html> <script> if(window.HTMLElement) {     HTMLElement.prototype.__defineSetter__("outerHTML",function(sHTML){         var r=this.ownerDocument.createRange();         r.setStartBefore(this);         var df=r.createContextualFragment(sHTML);         this.parentNode.replaceChild(df,this);         return sHTML;         });      HTMLElement.prototype.__defineGetter__("outerHTML",function(){      var attr;         var attrs=this.attributes;         var str="<"+this.tagName.toLowerCase();         for(var i=0;i<attrs.length;i++){             attr=attrs[i];             if(attr.specified)                 str+=" "+attr.name+'="'+attr.value+'"';             }         if(!this.canHaveChildren)             return str+">";         return str+">"+this.innerHTML+"</"+this.tagName.toLowerCase()+">";         });           HTMLElement.prototype.__defineGetter__("canHaveChildren",function(){   switch(this.tagName.toLowerCase()){             case "area":             case "base":          case "basefont":             case "col":             case "frame":             case "hr":             case "img":             case "br":             case "input":             case "isindex":             case "link":             case "meta":             case "param":             return false;         }         return true;       }); }  function showMe(i) {  	objHtml=document.all["s"+i].innerHTML; 	date=new Date(); 	if(navigator.userAgent.indexOf("MSIE")>0) 		window.status="cmdOpen,"+date.getTime()+","+(objHtml.substring(objHtml.lastIndexOf("\"",objHtml.indexOf(".swf\""))+1,objHtml.indexOf(".swf\"")+4)); 	else 		top.document.title="cmdOpen,"+date.getTime()+","+(objHtml.substring(objHtml.lastIndexOf("\"",objHtml.indexOf(".swf\""))+1,objHtml.indexOf(".swf\"")+4)); 	}  	if(navigator.userAgent.indexOf("MSIE")>0) 	var objects=document.all.tags("OBJECT"); 	else 	var objects=document.getElementsByTagName("OBJECT"); 	for(i=0;i<objects.length;i++) { objects[i].style.width="100%"; objects[i].outerHTML="<a href=# onclick=\"showMe("+i+")\">动画演示</a><span id=s"+i+" style=\"display:none\">"+objects[i].outerHTML+"</span>"; } var iHtml=document.body.innerHTML;  </script> 