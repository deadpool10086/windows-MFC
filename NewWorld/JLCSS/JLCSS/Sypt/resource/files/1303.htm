<html> <head> <meta http-equiv="Content-Type" content="text/html; charset=gb2312" /> <title></title> <link href="inc/style.css" rel="stylesheet" type="text/css"> </head>  <body class=infobody> <table width="100%" height="100%" cellspacing="0">  <tr>  <td valign="top"> <table>   <tr>   <td height=25></td>   </tr>           <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" style="border-bottom:#1873b5 solid 1px">             <tr><td style="background-image:url(images/cinfo_left.GIF);display:" width="5"></td>               <td width="86" height="28" style="padding-left:4px;padding-right:4px;background-image:url(images/cinfo_center.GIF);color:#3081bd;text-align:center;padding-bottom:0px;padding-top:4px;display:"><nobr>内容摘要</nobr></td> <td style="background-image:url(images/cinfo_right.GIF);display:" width="5"></td>               <td>&nbsp;</td>             </tr>           </table>           <table width="100%" border="0" align="center" cellpadding="5" cellspacing="1" bgcolor="#FFFFFF" style="border:#1873b5 solid 1px;border-top:0px">             <tr>               <td bgcolor="#F5FAFA" style="padding-left:20;padding-right:20px" id="ptitle">七. IP数据报分片<BR>&nbsp;&nbsp;&nbsp; 1.&nbsp; 最大传送单元（MTU）<BR>&nbsp;&nbsp;&nbsp; 2.&nbsp; 与分片有关的字段</td>             </tr>           </table> <table>   <tr>   <td height=25></td>   </tr>           <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" style="border-bottom:#1873b5 solid 1px">             <tr><td style="background-image:url(images/cinfo_left.GIF);display:" width="5"></td>               <td width="86" height="28" style="padding-left:4px;padding-right:4px;background-image:url(images/cinfo_center.GIF);color:#3081bd;text-align:center;padding-bottom:0px;padding-top:4px;display:"><nobr>相关内容</nobr></td> <td style="background-image:url(images/cinfo_right.GIF);display:" width="5"></td>               <td>&nbsp;</td>             </tr>           </table>           <table width="100%" border="0" align="center" cellpadding="5" cellspacing="1" bgcolor="#FFFFFF" style="border:#1873b5 solid 1px;border-top:0px">             <tr>               <td bgcolor="#F5FAFA" style="padding-left:20;padding-right:20px" id="ptitle"><P><STRONG>七. IP数据报分片</STRONG><BR>&nbsp;&nbsp;&nbsp; 数据包可能通过多个不同的网络。每一个路由器把收到的帧进行拆装，再进行处理，然后又封装成另一个帧。收到帧的格式与长度取决于这个帧刚刚经过的物理网络所使用的协议。发送出去的帧格式与长度则取决于这个帧将要经过的物理网络所使用的协议。例如，如果路由器把以太网连接到一个广域网，那么这个路由器收到的帧是以太网的格式，而发送的帧是广域网的格式。<BR><STRONG>1.&nbsp; 最大传送单元（MTU）</STRONG><BR>&nbsp;&nbsp;&nbsp; 不同的网络所能传送的数据包的最大长度是不同的，这个最大长度叫做最大传送单元（MTU），这是由网络所使用的硬件与软件所决定的。每种网络的数据链路层都有自己的帧格式，其中有一个字段是“数据字段最大长度”。当数据包封装成帧时，数据包的总长度必须小于这个数据字段最大长度，如下图所示。</P>
<P align=center><IMG src="../upload/1222568028906_pic.gif"></P>
<P align=center>图3-9&nbsp; MTU</P>
<P>&nbsp;&nbsp;&nbsp; 对于不同的物理网络协议，MTU的值是不同的。下表给出了不同协议的MTU值。</P>
<P align=center>表3-1&nbsp; 不同网络的MTU值</P>
<P align=center><IMG src="../upload/1222568037984_pic.gif"></P>
<P>&nbsp;&nbsp;&nbsp; 为了使IP协议与物理网络无关，IP协议不考虑底层网络的MTU，只是规定IP数据包的最大负载长度为65535字节。对于物理网络，如果数据包的长度超过了MTU，就要把数据包进行分割，使它们能够通过这些网络，这就叫做分片。源主机的传输层会自动对数据包进行分片工作，把数据包划分成IP协议和数据链路层都可接受的大小。<BR>&nbsp;&nbsp;&nbsp; 当数据包被分片时，每一个数据包片有它自己的首部，其中大部分的字段都是重复的，但有些是不同的。如果已经分片的数据包要经过更小MTU的网络，那么这些已经分片的数据包还可再进行分片，数据包在到达最后终点之前可以经过多次的分片。<BR>&nbsp;&nbsp;&nbsp; 数据包可以被源主机或在其路径上的路由器进行分片。但是数据包的重装却只能在目的主机上进行。由于被分片的数据包可能会通过不同的路由到达目的主机，所以应当在最后的目的主机上进行重装。<BR>&nbsp;&nbsp;&nbsp; 当数据包被分片时，首部中的一些字段会被复制到所有的分片中（选项字段可以被复制，也可不被复制）。有三个字段是与数据包分片相关的，这三个字段是：标识字段、标志字段和偏移量字段。当然，不管是否进行分片，校验和的值总是要重新计算的。<BR>&nbsp;&nbsp;&nbsp; 对于最大传输单元（MTU）还可以理解为某层协议报文可携带数据的最大长度，对于不同协议，对应的MTU可能会有不同的值和计算方法。如我们常说的“以太网MTU为1500”，说的是以太网MAC帧可封装的最大数据长度，其只包含IP报头及其上层协议数据的总长度。对于IP协议的MTU值应为65535-20，也只是说一个IP数据报（包含IP包头的长度和IP上层协议数据的长度），最多可以携带65535个字节的数据。<BR><STRONG>2.&nbsp; 与分片有关的字段</STRONG><BR>&nbsp;&nbsp;&nbsp; 与数据包的分片和重装有关的三个字段是：标识字段、标志字段和偏移量字段。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 标识：IP数据包的标识字段值与源IP地址惟一地确定了一个数据包。IP协议使用一个计数器来保证每个数据包标识的惟一性。当IP协议发送数据包时，就把这个计数器的当前值复制到标识字段中，并把这个记数器的值加1。当数据包被分片时，标识字段的值就复制到所有的分片中。这样所有的分片具有相同的标识。这个标识号在终点重装数据包时很有用。终点会将所有具有相同标识号的分片组装成一个数据包。<BR>&nbsp;&nbsp;&nbsp; ●&nbsp; 标志：这是一个长度为3位的字段。第一位保留。第二位是不分片位。若这个位为1，就表示不能把该数据包进行分片。若无法把这个数据包通过任何可用的物理网络进行转发，就丢弃这个数据包，并向源主机发送ICMP差错报文（关于ICMP差错报文，参见实验4）。若这个位为0，则在需要时可把这个数据包进行分片。第三位是还有分片位。若这个位是1，则表示这个数据包不是最后的分片，在这个分片后面还有其它分片。若这个位是0，则表示这是最后的分片。标志字段如下图所示：</P>
<P align=center><IMG src="../upload/1222568046609_pic.gif"></P>
<P align=center>图3-10&nbsp; 标志字段</P>
<P>&nbsp;&nbsp;&nbsp; ●&nbsp; 偏移量：偏移量字段表示一个分片在整个数据包中的相对位置。以8字节为度量单位。下图表示具有4000字节长度的数据包被划分为三个分片。在原始数据包中的数据编号是0～3999。第一个分片携带的数据是字节0～1399。对于这个数据包，偏移量是0／8＝0。第二个分片携带的数据是字节1400～2799；对于这个数据包，偏移量是1400／8＝175。最后，第三个分片携带的数据是字节2800～3999。对于这个数据包，偏移量是2800／8＝350。如下图。</P>
<P align=center><IMG src="../upload/1222568057593_pic.gif"></P>
<P align=center>图3-11&nbsp; 分片举例</P>
<P>&nbsp;&nbsp;&nbsp; 偏移量字段的长度只有13位，它不能表示超过8191的字节数，所以偏移量是以8字节为单位的。因此，把数据包进行分片的主机或路由器必须选择一个能够被8整除的长度来为数据包分片。</P></td>             </tr>           </table>  </td> </tr> </table> </body> </html> <script> if(window.HTMLElement) {     HTMLElement.prototype.__defineSetter__("outerHTML",function(sHTML){         var r=this.ownerDocument.createRange();         r.setStartBefore(this);         var df=r.createContextualFragment(sHTML);         this.parentNode.replaceChild(df,this);         return sHTML;         });      HTMLElement.prototype.__defineGetter__("outerHTML",function(){      var attr;         var attrs=this.attributes;         var str="<"+this.tagName.toLowerCase();         for(var i=0;i<attrs.length;i++){             attr=attrs[i];             if(attr.specified)                 str+=" "+attr.name+'="'+attr.value+'"';             }         if(!this.canHaveChildren)             return str+">";         return str+">"+this.innerHTML+"</"+this.tagName.toLowerCase()+">";         });           HTMLElement.prototype.__defineGetter__("canHaveChildren",function(){   switch(this.tagName.toLowerCase()){             case "area":             case "base":          case "basefont":             case "col":             case "frame":             case "hr":             case "img":             case "br":             case "input":             case "isindex":             case "link":             case "meta":             case "param":             return false;         }         return true;       }); }  function showMe(i) {  	objHtml=document.all["s"+i].innerHTML; 	date=new Date(); 	if(navigator.userAgent.indexOf("MSIE")>0) 		window.status="cmdOpen,"+date.getTime()+","+(objHtml.substring(objHtml.lastIndexOf("\"",objHtml.indexOf(".swf\""))+1,objHtml.indexOf(".swf\"")+4)); 	else 		top.document.title="cmdOpen,"+date.getTime()+","+(objHtml.substring(objHtml.lastIndexOf("\"",objHtml.indexOf(".swf\""))+1,objHtml.indexOf(".swf\"")+4)); 	}  	if(navigator.userAgent.indexOf("MSIE")>0) 	var objects=document.all.tags("OBJECT"); 	else 	var objects=document.getElementsByTagName("OBJECT"); 	for(i=0;i<objects.length;i++) { objects[i].style.width="100%"; objects[i].outerHTML="<a href=# onclick=\"showMe("+i+")\">动画演示</a><span id=s"+i+" style=\"display:none\">"+objects[i].outerHTML+"</span>"; } var iHtml=document.body.innerHTML;  </script> 